"use client";

import React, { useState, useMemo, useCallback } from "react";
import {
  X, Check, ChevronRight, ChevronLeft, MapPin, DollarSign,
  TrendingUp, TrendingDown, Zap, ShieldCheck, AlertTriangle,
  BarChart3, Target, Lightbulb, Building2, Info, Sparkles,
  ArrowRight, RefreshCw, Users, Briefcase, CheckCircle2, Calculator
} from "lucide-react";
import {
  USState, getAllUSStates, getNoIncomeTaxStates, US_STATE_TAX_DATA
} from "@/lib/us-state-tax-data";
import {
  USTaxProfile, USTaxCalculationResult, calculateUSTaxes,
  getStateTaxInsights, getUSSmartSuggestions, compareStates
} from "@/lib/us-tax-wizard-system";
import { TaxProfile } from "@/lib/types/tax-profile";

interface SmartTaxProfileModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (profile: Omit<TaxProfile, "id"> | TaxProfile) => void;
  profile?: TaxProfile | null;
}

type Step = "location" | "income" | "deductions" | "summary";

const FILING_STATUSES = [
  { id: "single", label: "Single", icon: "üë§", desc: "Not married" },
  { id: "married-joint", label: "Married Filing Jointly", icon: "üë´", desc: "Married, filing together" },
  { id: "married-separate", label: "Married Separately", icon: "üë§üë§", desc: "Married, filing apart" },
  { id: "head-of-household", label: "Head of Household", icon: "üè†", desc: "Unmarried with dependents" },
] as const;

const EMPLOYMENT_STATUSES = [
  { id: "employed", label: "W-2 Employee", icon: "üíº", desc: "Employer withholds taxes" },
  { id: "self-employed", label: "Self-Employed", icon: "üè¢", desc: "Freelancer / contractor" },
  { id: "unemployed", label: "Unemployed", icon: "‚è∏Ô∏è", desc: "Currently not working" },
  { id: "retired", label: "Retired", icon: "üèñÔ∏è", desc: "Retirement income" },
] as const;

const BUSINESS_TYPES = [
  { id: "sole-proprietor", label: "Sole Proprietor", desc: "Schedule C, simplest" },
  { id: "llc", label: "LLC", desc: "Pass-through, liability protection" },
  { id: "s-corp", label: "S-Corp", desc: "Reduce SE tax on higher income" },
  { id: "c-corp", label: "C-Corp", desc: "21% flat corporate rate" },
  { id: "partnership", label: "Partnership", desc: "Multiple owners, pass-through" },
] as const;

function formatDollar(n: number): string {
  if (n >= 1_000_000) return `$${(n / 1_000_000).toFixed(2)}M`;
  if (n >= 1_000) return `$${(n / 1_000).toFixed(1)}K`;
  return `$${n.toFixed(0)}`;
}

function formatDollarFull(n: number): string {
  return `$${n.toLocaleString("en-US", { maximumFractionDigits: 0 })}`;
}

// Tax bracket visualization bar
function BracketBar({
  taxableIncome,
  filingStatus,
}: {
  taxableIncome: number;
  filingStatus: USTaxProfile["filingStatus"];
}) {
  const brackets =
    filingStatus === "married-joint"
      ? [
          { min: 0, max: 23200, rate: 10, color: "#22c55e" },
          { min: 23200, max: 94300, rate: 12, color: "#84cc16" },
          { min: 94300, max: 201050, rate: 22, color: "#eab308" },
          { min: 201050, max: 383900, rate: 24, color: "#f97316" },
          { min: 383900, max: 487450, rate: 32, color: "#ef4444" },
          { min: 487450, max: 731200, rate: 35, color: "#dc2626" },
          { min: 731200, max: Infinity, rate: 37, color: "#991b1b" },
        ]
      : [
          { min: 0, max: 11600, rate: 10, color: "#22c55e" },
          { min: 11600, max: 47150, rate: 12, color: "#84cc16" },
          { min: 47150, max: 100525, rate: 22, color: "#eab308" },
          { min: 100525, max: 191950, rate: 24, color: "#f97316" },
          { min: 191950, max: 243725, rate: 32, color: "#ef4444" },
          { min: 243725, max: 609350, rate: 35, color: "#dc2626" },
          { min: 609350, max: Infinity, rate: 37, color: "#991b1b" },
        ];

  const maxDisplay = Math.max(taxableIncome * 1.2, 100000);
  let marginalRate = 0;
  for (const b of brackets) {
    if (taxableIncome > b.min) marginalRate = b.rate;
  }

  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <span className="text-xs text-gray-400 font-medium">Federal Tax Brackets</span>
        <span className="text-xs font-bold text-orange-400">
          Marginal Rate: {marginalRate}%
        </span>
      </div>
      <div className="flex h-3 rounded-full overflow-hidden gap-px">
        {brackets.map((b) => {
          const bracketMax = b.max === Infinity ? maxDisplay : Math.min(b.max, maxDisplay);
          const width = ((bracketMax - b.min) / maxDisplay) * 100;
          const isFilled = taxableIncome > b.min;
          const isPartial = taxableIncome > b.min && taxableIncome < (b.max === Infinity ? Infinity : b.max);
          const fillPercent = isPartial
            ? ((taxableIncome - b.min) / (bracketMax - b.min)) * 100
            : isFilled
            ? 100
            : 0;

          return (
            <div
              key={b.rate}
              className="relative rounded-sm overflow-hidden"
              style={{ width: `${width}%`, backgroundColor: "#1a1a1a" }}
              title={`${b.rate}% bracket`}
            >
              <div
                className="absolute inset-y-0 left-0 transition-all duration-500"
                style={{ width: `${fillPercent}%`, backgroundColor: b.color }}
              />
            </div>
          );
        })}
      </div>
      <div className="flex justify-between mt-1 text-[9px] text-gray-600">
        {brackets.slice(0, 5).map((b) => (
          <span key={b.rate}>{b.rate}%</span>
        ))}
      </div>
      {taxableIncome > 0 && (
        <div
          className="mt-2 text-xs text-center font-medium"
          style={{ color: marginalRate > 25 ? "#ef4444" : marginalRate > 15 ? "#f97316" : "#22c55e" }}
        >
          Your income falls in the {marginalRate}% federal bracket
        </div>
      )}
    </div>
  );
}

// Live metric card
function MetricCard({
  label,
  value,
  sub,
  color = "white",
  large = false,
}: {
  label: string;
  value: string;
  sub?: string;
  color?: "white" | "red" | "green" | "blue" | "orange" | "yellow";
  large?: boolean;
}) {
  const colorClass = {
    white: "text-white",
    red: "text-red-400",
    green: "text-emerald-400",
    blue: "text-blue-400",
    orange: "text-orange-400",
    yellow: "text-yellow-400",
  }[color];

  return (
    <div className="bg-[#111] rounded-xl p-4 border border-white/5">
      <div className="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-1">{label}</div>
      <div className={`font-mono font-bold ${large ? "text-2xl" : "text-lg"} ${colorClass}`}>{value}</div>
      {sub && <div className="text-[10px] text-gray-500 mt-0.5">{sub}</div>}
    </div>
  );
}

// State search/picker
function StatePicker({
  value,
  onChange,
}: {
  value: USState;
  onChange: (s: USState) => void;
}) {
  const [query, setQuery] = useState("");
  const [open, setOpen] = useState(false);
  const all = getAllUSStates();
  const noTax = getNoIncomeTaxStates();
  const filtered = query
    ? all.filter((s) => s.toLowerCase().includes(query.toLowerCase()))
    : all;

  const stateData = US_STATE_TAX_DATA[value];
  const isNoTaxState = noTax.includes(value);
  const topRate =
    stateData?.individualIncomeTax?.brackets?.slice(-1)[0]?.rate ?? 0;

  return (
    <div className="relative">
      <button
        type="button"
        onClick={() => setOpen(!open)}
        className={`w-full flex items-center justify-between px-4 py-3 rounded-xl border transition-all ${
          open
            ? "bg-[#1A1A1A] border-blue-500/50 ring-2 ring-blue-500/20"
            : "bg-[#1A1A1A] border-white/10 hover:bg-white/5"
        }`}
      >
        <div className="flex items-center gap-3">
          <MapPin className="w-4 h-4 text-blue-400 flex-shrink-0" />
          <div className="text-left">
            <div className="font-bold text-white">{value}</div>
            <div className="text-xs text-gray-400 flex items-center gap-2 mt-0.5">
              {isNoTaxState ? (
                <span className="text-emerald-400 font-semibold">‚ú® No Income Tax</span>
              ) : (
                <span>Top rate: {topRate}%</span>
              )}
            </div>
          </div>
        </div>
        <ChevronRight className={`w-4 h-4 text-gray-500 transition-transform ${open ? "rotate-90" : ""}`} />
      </button>

      {open && (
        <div className="absolute z-50 mt-2 w-full bg-[#1A1A1A] border border-white/10 rounded-xl shadow-2xl overflow-hidden">
          <div className="p-3 border-b border-white/10">
            <input
              autoFocus
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              placeholder="Search state..."
              className="w-full bg-black/30 text-white text-sm px-3 py-2 rounded-lg border border-white/10 outline-none focus:ring-2 focus:ring-blue-500/40"
            />
          </div>
          <div className="max-h-[260px] overflow-y-auto p-2 space-y-0.5">
            {/* No-tax states first */}
            {!query && (
              <div className="px-2 pt-1 pb-0.5 text-[10px] text-gray-500 font-bold uppercase tracking-wider">
                ‚ú® No Income Tax States
              </div>
            )}
            {filtered
              .filter((s) => !query || true)
              .map((s) => {
                const noTax = getNoIncomeTaxStates().includes(s);
                const data = US_STATE_TAX_DATA[s];
                const rate = data?.individualIncomeTax?.brackets?.slice(-1)[0]?.rate ?? 0;
                if (!query && !noTax && filtered.indexOf(s) < 9) return null;
                return (
                  <button
                    key={s}
                    onClick={() => {
                      onChange(s);
                      setOpen(false);
                      setQuery("");
                    }}
                    className={`w-full text-left px-3 py-2 rounded-lg flex items-center justify-between transition-colors ${
                      s === value ? "bg-blue-500/20 text-blue-400" : "hover:bg-white/5 text-white"
                    }`}
                  >
                    <span className="font-medium text-sm">{s}</span>
                    <span className={`text-xs ${noTax ? "text-emerald-400 font-semibold" : "text-gray-400"}`}>
                      {noTax ? "No Tax" : `${rate}%`}
                    </span>
                  </button>
                );
              })}
            {query &&
              filtered.map((s) => {
                const noTax = getNoIncomeTaxStates().includes(s);
                const data = US_STATE_TAX_DATA[s];
                const rate = data?.individualIncomeTax?.brackets?.slice(-1)[0]?.rate ?? 0;
                return (
                  <button
                    key={s}
                    onClick={() => {
                      onChange(s);
                      setOpen(false);
                      setQuery("");
                    }}
                    className={`w-full text-left px-3 py-2 rounded-lg flex items-center justify-between transition-colors ${
                      s === value ? "bg-blue-500/20 text-blue-400" : "hover:bg-white/5 text-white"
                    }`}
                  >
                    <span className="font-medium text-sm">{s}</span>
                    <span className={`text-xs ${noTax ? "text-emerald-400 font-semibold" : "text-gray-400"}`}>
                      {noTax ? "No Tax" : `${rate}%`}
                    </span>
                  </button>
                );
              })}
          </div>
        </div>
      )}
    </div>
  );
}

// Currency input
function CurrencyInput({
  label,
  value,
  onChange,
  hint,
  optional = false,
}: {
  label: string;
  value: number;
  onChange: (n: number) => void;
  hint?: string;
  optional?: boolean;
}) {
  const [raw, setRaw] = useState(value === 0 ? "" : String(value));

  return (
    <div>
      <div className="flex items-center justify-between mb-1.5">
        <label className="text-sm font-medium text-gray-400">{label}</label>
        {optional && <span className="text-[10px] text-gray-600 uppercase tracking-wider">Optional</span>}
      </div>
      <div className="relative">
        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm font-medium">$</span>
        <input
          type="number"
          min={0}
          step={1000}
          value={raw}
          onChange={(e) => {
            setRaw(e.target.value);
            const n = parseFloat(e.target.value) || 0;
            onChange(n);
          }}
          onFocus={() => { if (value === 0) setRaw(""); }}
          onBlur={() => { if (raw === "") { setRaw(""); onChange(0); } }}
          placeholder="0"
          className="w-full pl-7 pr-4 py-3 bg-[#111] border border-white/10 rounded-xl text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/40 focus:border-blue-500/30 placeholder-gray-700 transition-all"
        />
      </div>
      {hint && <p className="text-xs text-gray-600 mt-1">{hint}</p>}
    </div>
  );
}

export function SmartTaxProfileModal({
  isOpen,
  onClose,
  onSave,
  profile,
}: SmartTaxProfileModalProps) {
  const [step, setStep] = useState<Step>("location");
  const [profileName, setProfileName] = useState(profile?.name ?? "");

  // US Tax Profile state
  const [taxProfile, setTaxProfile] = useState<USTaxProfile>({
    state: "California" as USState,
    filingStatus: "single",
    employmentStatus: "employed",
    standardDeduction: true,
    w2Income: 0,
    selfEmploymentIncome: 0,
    businessIncome: 0,
    capitalGains: 0,
    dividends: 0,
    interest: 0,
    rentalIncome: 0,
    otherIncome: 0,
    businessExpenses: 0,
    itemizedDeductions: 0,
    retirementContributions: 0,
  });

  const update = useCallback(
    <K extends keyof USTaxProfile>(k: K, v: USTaxProfile[K]) =>
      setTaxProfile((prev) => ({ ...prev, [k]: v })),
    []
  );

  // Live calculation
  const calc = useMemo<USTaxCalculationResult | null>(() => {
    try {
      return calculateUSTaxes(taxProfile);
    } catch {
      return null;
    }
  }, [taxProfile]);

  const suggestions = useMemo(
    () => (calc ? getUSSmartSuggestions(taxProfile, calc) : []),
    [taxProfile, calc]
  );

  const stateInsights = useMemo(
    () => getStateTaxInsights(taxProfile.state),
    [taxProfile.state]
  );

  // Comparisons: current state vs Florida/Texas (no-tax)
  const stateComparisons = useMemo(() => {
    if (!calc || calc.breakdown.grossIncome === 0) return [];
    const compare = ["Florida", "Texas", "Nevada"] as USState[];
    const current = taxProfile.state;
    const states = [current, ...compare.filter((s) => s !== current)];
    return compareStates(states, calc.breakdown.grossIncome, taxProfile.filingStatus).slice(0, 4);
  }, [calc, taxProfile.state, taxProfile.filingStatus]);

  const steps: Step[] = ["location", "income", "deductions", "summary"];
  const stepLabels: Record<Step, string> = {
    location: "Location & Status",
    income: "Income",
    deductions: "Deductions",
    summary: "Summary",
  };

  const currentIndex = steps.indexOf(step);

  const canNext = useMemo(() => {
    if (step === "location") return profileName.trim().length > 0;
    return true;
  }, [step, profileName]);

  const handleSave = () => {
    const grossIncome = calc?.breakdown.grossIncome ?? 0;
    const formData: Omit<TaxProfile, "id"> = {
      name: profileName,
      country: "USA",
      companyType: taxProfile.businessType === "llc"
        ? "llc"
        : taxProfile.businessType === "s-corp"
        ? "s_corporation"
        : taxProfile.businessType === "c-corp"
        ? "corporation"
        : taxProfile.businessType === "partnership"
        ? "partnership"
        : taxProfile.businessType === "sole-proprietor"
        ? "sole_proprietor"
        : "individual",
      salaryIncome: taxProfile.w2Income ?? 0,
      businessIncome: taxProfile.businessIncome ?? taxProfile.selfEmploymentIncome ?? 0,
      capitalGains: {
        shortTerm: taxProfile.capitalGains ?? 0,
        longTerm: 0,
      },
      dividends: taxProfile.dividends ?? 0,
      rentalIncome: taxProfile.rentalIncome ?? 0,
      cryptoGains: 0,
      deductibleExpenses: taxProfile.businessExpenses ?? taxProfile.itemizedDeductions ?? 0,
      customIncomeSources: [],
      notes: `State: ${taxProfile.state} | Filing: ${taxProfile.filingStatus} | Effective Rate: ${calc?.totalEffectiveRate.toFixed(1) ?? 0}%`,
      isActive: false,
    };
    if (profile) {
      onSave({ ...formData, id: profile.id });
    } else {
      onSave(formData);
    }
    onClose();
  };

  if (!isOpen) return null;

  const isSelfEmployed = taxProfile.employmentStatus === "self-employed";

  return (
    <div
      className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[1000003]"
      onClick={onClose}
    >
      <div
        className="bg-[#0D0D0D] border border-white/10 rounded-3xl w-[960px] max-h-[92vh] flex flex-col shadow-2xl overflow-hidden"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between px-8 pt-7 pb-5 border-b border-white/10 flex-shrink-0">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-blue-500/20 rounded-xl">
              <Calculator className="w-5 h-5 text-blue-400" />
            </div>
            <div>
              <h2 className="text-xl font-bold text-white">
                {profile ? "Edit Tax Profile" : "New Tax Profile"}
              </h2>
              <p className="text-xs text-gray-500 mt-0.5">
                USA ¬∑ Real-time federal + state calculations
              </p>
            </div>
          </div>

          {/* Compact live metrics in header */}
          {calc && calc.breakdown.grossIncome > 0 && (
            <div className="hidden lg:flex items-center gap-6">
              <div className="text-right">
                <div className="text-[10px] text-gray-500 uppercase tracking-widest">Total Tax</div>
                <div className="text-lg font-bold text-red-400 font-mono">
                  {formatDollar(calc.totalTaxLiability)}
                </div>
              </div>
              <div className="text-right">
                <div className="text-[10px] text-gray-500 uppercase tracking-widest">Net Income</div>
                <div className="text-lg font-bold text-emerald-400 font-mono">
                  {formatDollar(calc.netIncome)}
                </div>
              </div>
              <div className="text-right">
                <div className="text-[10px] text-gray-500 uppercase tracking-widest">Rate</div>
                <div className="text-lg font-bold text-orange-400 font-mono">
                  {calc.totalEffectiveRate.toFixed(1)}%
                </div>
              </div>
            </div>
          )}

          <button
            onClick={onClose}
            className="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition-colors ml-4"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* Step Progress */}
        <div className="px-8 py-4 flex items-center gap-2 flex-shrink-0">
          {steps.map((s, i) => {
            const done = i < currentIndex;
            const active = s === step;
            return (
              <React.Fragment key={s}>
                <button
                  onClick={() => { if (done || active) setStep(s); }}
                  disabled={!done && !active}
                  className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider transition-all ${
                    active
                      ? "bg-blue-500 text-white shadow-lg shadow-blue-500/30"
                      : done
                      ? "bg-emerald-500/20 text-emerald-400"
                      : "bg-white/5 text-gray-600 cursor-not-allowed"
                  }`}
                >
                  {done ? <Check className="w-3 h-3" /> : <span>{i + 1}</span>}
                  <span className="hidden sm:inline">{stepLabels[s]}</span>
                </button>
                {i < steps.length - 1 && (
                  <div className={`flex-1 h-0.5 rounded-full ${done ? "bg-emerald-500/40" : "bg-white/5"}`} />
                )}
              </React.Fragment>
            );
          })}
        </div>

        {/* Main Layout: form left, live panel right */}
        <div className="flex flex-1 min-h-0 overflow-hidden">
          {/* LEFT: Form */}
          <div className="flex-1 overflow-y-auto p-8 space-y-6 custom-scrollbar">

            {/* ‚îÄ‚îÄ STEP 1: Location & Status ‚îÄ‚îÄ */}
            {step === "location" && (
              <div className="space-y-6">
                {/* Profile name */}
                <div>
                  <label className="block text-sm font-medium text-gray-400 mb-2">
                    Profile Name *
                  </label>
                  <input
                    type="text"
                    value={profileName}
                    onChange={(e) => setProfileName(e.target.value)}
                    placeholder="e.g., 2026 Main Profile"
                    className="w-full px-4 py-3 bg-[#1A1A1A] border border-white/10 rounded-xl text-white font-medium placeholder-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500/40 transition-all"
                  />
                </div>

                {/* State picker */}
                <div>
                  <label className="block text-sm font-medium text-gray-400 mb-2 flex items-center gap-2">
                    <MapPin className="w-4 h-4" /> State of Residence *
                  </label>
                  <StatePicker
                    value={taxProfile.state}
                    onChange={(s) => update("state", s)}
                  />
                  {/* State insight badge */}
                  <div className="mt-2 flex flex-wrap gap-2">
                    {stateInsights.advantages.slice(0, 2).map((a, i) => (
                      <span key={i} className="text-[11px] px-2.5 py-1 bg-emerald-500/10 text-emerald-400 rounded-lg border border-emerald-500/20">
                        ‚úì {a}
                      </span>
                    ))}
                    {stateInsights.considerations.slice(0, 1).map((c, i) => (
                      <span key={i} className="text-[11px] px-2.5 py-1 bg-orange-500/10 text-orange-400 rounded-lg border border-orange-500/20">
                        ‚ö† {c}
                      </span>
                    ))}
                  </div>
                </div>

                {/* Filing Status */}
                <div>
                  <label className="block text-sm font-medium text-gray-400 mb-2 flex items-center gap-2">
                    <Users className="w-4 h-4" /> Filing Status *
                  </label>
                  <div className="grid grid-cols-2 gap-3">
                    {FILING_STATUSES.map((fs) => {
                      const selected = taxProfile.filingStatus === fs.id;
                      return (
                        <button
                          key={fs.id}
                          type="button"
                          onClick={() => update("filingStatus", fs.id as USTaxProfile["filingStatus"])}
                          className={`p-3 rounded-xl border text-left transition-all ${
                            selected
                              ? "border-blue-500/50 bg-blue-500/10"
                              : "border-white/10 bg-[#1A1A1A] hover:bg-white/5"
                          }`}
                        >
                          <div className="flex items-center gap-2 mb-0.5">
                            <span className="text-xl">{fs.icon}</span>
                            <span className={`text-sm font-semibold ${selected ? "text-blue-400" : "text-white"}`}>
                              {fs.label}
                            </span>
                          </div>
                          <p className="text-xs text-gray-500">{fs.desc}</p>
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* Employment Status */}
                <div>
                  <label className="block text-sm font-medium text-gray-400 mb-2 flex items-center gap-2">
                    <Briefcase className="w-4 h-4" /> Employment Status *
                  </label>
                  <div className="grid grid-cols-2 gap-3">
                    {EMPLOYMENT_STATUSES.map((es) => {
                      const selected = taxProfile.employmentStatus === es.id;
                      return (
                        <button
                          key={es.id}
                          type="button"
                          onClick={() => update("employmentStatus", es.id as USTaxProfile["employmentStatus"])}
                          className={`p-3 rounded-xl border text-left transition-all ${
                            selected
                              ? "border-blue-500/50 bg-blue-500/10"
                              : "border-white/10 bg-[#1A1A1A] hover:bg-white/5"
                          }`}
                        >
                          <div className="flex items-center gap-2 mb-0.5">
                            <span className="text-lg">{es.icon}</span>
                            <span className={`text-sm font-semibold ${selected ? "text-blue-400" : "text-white"}`}>
                              {es.label}
                            </span>
                          </div>
                          <p className="text-xs text-gray-500">{es.desc}</p>
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* Business type (if self-employed) */}
                {isSelfEmployed && (
                  <div>
                    <label className="block text-sm font-medium text-gray-400 mb-2 flex items-center gap-2">
                      <Building2 className="w-4 h-4" /> Business Structure
                    </label>
                    <div className="space-y-2">
                      {BUSINESS_TYPES.map((bt) => {
                        const selected = taxProfile.businessType === bt.id;
                        return (
                          <button
                            key={bt.id}
                            type="button"
                            onClick={() => update("businessType", bt.id as USTaxProfile["businessType"])}
                            className={`w-full p-3 rounded-xl border text-left transition-all flex items-center justify-between ${
                              selected
                                ? "border-blue-500/50 bg-blue-500/10"
                                : "border-white/10 bg-[#1A1A1A] hover:bg-white/5"
                            }`}
                          >
                            <div>
                              <span className={`text-sm font-semibold ${selected ? "text-blue-400" : "text-white"}`}>
                                {bt.label}
                              </span>
                              <p className="text-xs text-gray-500">{bt.desc}</p>
                            </div>
                            {selected && <Check className="w-4 h-4 text-blue-500 flex-shrink-0" />}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ‚îÄ‚îÄ STEP 2: Income ‚îÄ‚îÄ */}
            {step === "income" && (
              <div className="space-y-5">
                <div className="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4 flex items-start gap-3">
                  <Info className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
                  <p className="text-sm text-blue-300">
                    Enter your <strong>annual</strong> figures. All numbers in USD. The calculator updates live as you type.
                  </p>
                </div>

                {taxProfile.employmentStatus !== "self-employed" && (
                  <CurrencyInput
                    label="W-2 / Salary Income"
                    value={taxProfile.w2Income ?? 0}
                    onChange={(v) => update("w2Income", v)}
                    hint="Gross wages from employment (Box 1 on your W-2)"
                  />
                )}

                {isSelfEmployed && (
                  <>
                    <CurrencyInput
                      label="Self-Employment / Business Income"
                      value={taxProfile.selfEmploymentIncome ?? 0}
                      onChange={(v) => update("selfEmploymentIncome", v)}
                      hint="Net profit before SE tax deduction"
                    />
                    <CurrencyInput
                      label="Business Expenses"
                      value={taxProfile.businessExpenses ?? 0}
                      onChange={(v) => update("businessExpenses", v)}
                      hint="Deductible operating expenses"
                      optional
                    />
                  </>
                )}

                <div className="border-t border-white/5 pt-4">
                  <p className="text-xs text-gray-500 uppercase tracking-widest font-bold mb-4">Investment Income</p>
                  <div className="space-y-4">
                    <CurrencyInput
                      label="Capital Gains"
                      value={taxProfile.capitalGains ?? 0}
                      onChange={(v) => update("capitalGains", v)}
                      hint="Net realized gains from stocks, crypto, real estate, etc."
                      optional
                    />
                    <CurrencyInput
                      label="Qualified Dividends"
                      value={taxProfile.dividends ?? 0}
                      onChange={(v) => update("dividends", v)}
                      optional
                    />
                    <CurrencyInput
                      label="Interest Income"
                      value={taxProfile.interest ?? 0}
                      onChange={(v) => update("interest", v)}
                      optional
                    />
                  </div>
                </div>

                <div className="border-t border-white/5 pt-4">
                  <p className="text-xs text-gray-500 uppercase tracking-widest font-bold mb-4">Other Income</p>
                  <div className="space-y-4">
                    <CurrencyInput
                      label="Rental Income"
                      value={taxProfile.rentalIncome ?? 0}
                      onChange={(v) => update("rentalIncome", v)}
                      optional
                    />
                    <CurrencyInput
                      label="Other Income"
                      value={taxProfile.otherIncome ?? 0}
                      onChange={(v) => update("otherIncome", v)}
                      hint="Alimony, gambling, 1099-MISC, etc."
                      optional
                    />
                  </div>
                </div>
              </div>
            )}

            {/* ‚îÄ‚îÄ STEP 3: Deductions ‚îÄ‚îÄ */}
            {step === "deductions" && (
              <div className="space-y-5">
                {/* Standard vs Itemized */}
                <div>
                  <label className="block text-sm font-medium text-gray-400 mb-3">Deduction Method</label>
                  <div className="grid grid-cols-2 gap-3">
                    {[
                      {
                        id: true,
                        label: "Standard Deduction",
                        sub:
                          taxProfile.filingStatus === "married-joint"
                            ? "$29,200 (2025)"
                            : "$14,600 (2025)",
                        recommended: true,
                      },
                      {
                        id: false,
                        label: "Itemized Deductions",
                        sub: "Mortgage interest, state taxes, charity‚Ä¶",
                        recommended: false,
                      },
                    ].map((opt) => {
                      const selected = taxProfile.standardDeduction === opt.id;
                      return (
                        <button
                          key={String(opt.id)}
                          type="button"
                          onClick={() => update("standardDeduction", opt.id)}
                          className={`p-4 rounded-xl border text-left transition-all ${
                            selected
                              ? "border-blue-500/50 bg-blue-500/10"
                              : "border-white/10 bg-[#1A1A1A] hover:bg-white/5"
                          }`}
                        >
                          <div className={`font-semibold text-sm mb-1 ${selected ? "text-blue-400" : "text-white"}`}>
                            {opt.label}
                          </div>
                          <div className="text-xs text-gray-500">{opt.sub}</div>
                          {opt.recommended && (
                            <div className="mt-2 text-[10px] text-emerald-400 font-bold uppercase tracking-wider">
                              ‚úì Recommended for most
                            </div>
                          )}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {!taxProfile.standardDeduction && (
                  <CurrencyInput
                    label="Total Itemized Deductions"
                    value={taxProfile.itemizedDeductions ?? 0}
                    onChange={(v) => update("itemizedDeductions", v)}
                    hint="Sum of mortgage interest, state taxes (SALT cap $10k), charitable donations, etc."
                  />
                )}

                <CurrencyInput
                  label="Retirement Contributions"
                  value={taxProfile.retirementContributions ?? 0}
                  onChange={(v) => update("retirementContributions", v)}
                  hint="401(k) up to $23,000 ¬∑ Traditional IRA up to $7,000 (2025)"
                  optional
                />

                {/* Deduction impact card */}
                {calc && (
                  <div className="bg-[#1A1A1A] rounded-xl p-4 border border-white/10">
                    <div className="text-xs text-gray-500 uppercase tracking-widest font-bold mb-3">Deduction Impact</div>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-400">AGI (before deductions)</span>
                        <span className="font-mono font-bold text-white">
                          {formatDollarFull(calc.breakdown.adjustedGrossIncome)}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-400">Deductions applied</span>
                        <span className="font-mono font-bold text-emerald-400">
                          ‚àí{formatDollarFull(calc.breakdown.deductions)}
                        </span>
                      </div>
                      <div className="flex justify-between border-t border-white/5 pt-2">
                        <span className="text-gray-400 font-semibold">Taxable Income</span>
                        <span className="font-mono font-bold text-blue-400">
                          {formatDollarFull(calc.breakdown.taxableIncome)}
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ‚îÄ‚îÄ STEP 4: Summary ‚îÄ‚îÄ */}
            {step === "summary" && calc && (
              <div className="space-y-5">
                <div className="bg-gradient-to-br from-blue-500/10 to-purple-500/10 border border-blue-500/20 rounded-2xl p-6">
                  <div className="text-xs text-gray-400 uppercase tracking-widest mb-1">Total Tax Liability</div>
                  <div className="text-4xl font-black font-mono text-white mb-1">
                    {formatDollarFull(calc.totalTaxLiability)}
                  </div>
                  <div className="flex items-center gap-3 mt-3">
                    <div className="text-sm text-gray-400">
                      Effective rate: <span className="font-bold text-orange-400">{calc.totalEffectiveRate.toFixed(2)}%</span>
                    </div>
                    <div className="text-sm text-gray-400">
                      Net income: <span className="font-bold text-emerald-400">{formatDollarFull(calc.netIncome)}</span>
                    </div>
                  </div>

                  {/* Visual income pie */}
                  <div className="mt-4">
                    <div className="flex h-3 rounded-full overflow-hidden gap-0.5">
                      <div
                        className="bg-red-500 transition-all duration-700"
                        style={{ width: `${(calc.federalIncomeTax / calc.breakdown.grossIncome) * 100}%` }}
                        title={`Federal: ${formatDollarFull(calc.federalIncomeTax)}`}
                      />
                      <div
                        className="bg-orange-500 transition-all duration-700"
                        style={{ width: `${(calc.stateIncomeTax / calc.breakdown.grossIncome) * 100}%` }}
                        title={`State: ${formatDollarFull(calc.stateIncomeTax)}`}
                      />
                      {calc.selfEmploymentTax > 0 && (
                        <div
                          className="bg-yellow-500 transition-all duration-700"
                          style={{ width: `${(calc.selfEmploymentTax / calc.breakdown.grossIncome) * 100}%` }}
                          title={`SE Tax: ${formatDollarFull(calc.selfEmploymentTax)}`}
                        />
                      )}
                      <div
                        className="bg-emerald-500 transition-all duration-700"
                        style={{ width: `${(calc.netIncome / calc.breakdown.grossIncome) * 100}%` }}
                      />
                    </div>
                    <div className="flex items-center gap-4 mt-2 text-[11px] flex-wrap">
                      <span className="flex items-center gap-1.5 text-red-400"><span className="w-2 h-2 bg-red-500 rounded-full" />Federal</span>
                      <span className="flex items-center gap-1.5 text-orange-400"><span className="w-2 h-2 bg-orange-500 rounded-full" />State</span>
                      {calc.selfEmploymentTax > 0 && (
                        <span className="flex items-center gap-1.5 text-yellow-400"><span className="w-2 h-2 bg-yellow-500 rounded-full" />SE Tax</span>
                      )}
                      <span className="flex items-center gap-1.5 text-emerald-400"><span className="w-2 h-2 bg-emerald-500 rounded-full" />Net Income</span>
                    </div>
                  </div>
                </div>

                {/* Detailed breakdown */}
                <div className="bg-[#1A1A1A] rounded-xl p-5 border border-white/10 space-y-3">
                  <div className="text-xs text-gray-500 uppercase tracking-widest font-bold mb-1">Tax Breakdown</div>
                  {[
                    { label: "Gross Income", value: calc.breakdown.grossIncome, color: "text-white" },
                    { label: "Adjusted Gross Income", value: calc.breakdown.adjustedGrossIncome, color: "text-white" },
                    { label: "Taxable Income", value: calc.breakdown.taxableIncome, color: "text-blue-400" },
                    { label: "Federal Income Tax", value: -calc.federalIncomeTax, color: "text-red-400", rate: calc.federalEffectiveRate },
                    { label: "State Income Tax", value: -calc.stateIncomeTax, color: "text-orange-400", rate: calc.stateEffectiveRate },
                    ...(calc.selfEmploymentTax > 0 ? [{ label: "Self-Employment Tax (15.3%)", value: -calc.selfEmploymentTax, color: "text-yellow-400" }] : []),
                    ...(calc.annualLLCFees > 0 ? [{ label: "LLC Annual Fees", value: -calc.annualLLCFees, color: "text-orange-400" }] : []),
                  ].map((row, i) => (
                    <div key={i} className="flex items-center justify-between py-1 border-b border-white/5 last:border-0">
                      <span className="text-sm text-gray-400">{row.label}</span>
                      <div className="text-right">
                        <span className={`text-sm font-mono font-bold ${row.color}`}>
                          {row.value < 0 ? `‚àí${formatDollarFull(Math.abs(row.value))}` : formatDollarFull(row.value)}
                        </span>
                        {"rate" in row && (
                          <div className="text-[10px] text-gray-600">{row.rate?.toFixed(1)}% effective</div>
                        )}
                      </div>
                    </div>
                  ))}
                  <div className="flex items-center justify-between pt-2">
                    <span className="text-sm font-bold text-white">Net Income</span>
                    <span className="text-lg font-black font-mono text-emerald-400">
                      {formatDollarFull(calc.netIncome)}
                    </span>
                  </div>
                </div>

                {/* State comparison */}
                {stateComparisons.length > 1 && (
                  <div className="bg-[#1A1A1A] rounded-xl p-5 border border-white/10">
                    <div className="text-xs text-gray-500 uppercase tracking-widest font-bold mb-3 flex items-center gap-2">
                      <BarChart3 className="w-4 h-4" /> State Tax Comparison
                    </div>
                    <div className="space-y-2">
                      {stateComparisons.map((comp) => {
                        const isCurrent = comp.state === taxProfile.state;
                        const maxTax = Math.max(...stateComparisons.map((c) => c.stateTax));
                        const barWidth = maxTax > 0 ? (comp.stateTax / maxTax) * 100 : 0;
                        return (
                          <div key={comp.state} className="flex items-center gap-3">
                            <div className={`w-28 text-xs font-medium ${isCurrent ? "text-blue-400 font-bold" : "text-gray-400"}`}>
                              {comp.state} {isCurrent && "‚óè"}
                            </div>
                            <div className="flex-1 bg-white/5 rounded-full h-2 overflow-hidden">
                              <div
                                className={`h-full rounded-full transition-all duration-700 ${comp.stateTax === 0 ? "bg-emerald-500" : isCurrent ? "bg-blue-500" : "bg-gray-600"}`}
                                style={{ width: `${Math.max(barWidth, comp.stateTax === 0 ? 2 : 2)}%` }}
                              />
                            </div>
                            <div className="w-24 text-right">
                              <span className={`text-xs font-mono font-bold ${comp.stateTax === 0 ? "text-emerald-400" : "text-white"}`}>
                                {comp.stateTax === 0 ? "$0 saved" : formatDollarFull(comp.stateTax)}
                              </span>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    {stateComparisons[0].stateTax < (calc?.stateIncomeTax ?? 0) && (
                      <div className="mt-3 text-xs text-amber-400 font-medium">
                        üí° Moving to {stateComparisons[0].state} could save ~{formatDollarFull((calc?.stateIncomeTax ?? 0) - stateComparisons[0].stateTax)}/year in state taxes
                      </div>
                    )}
                  </div>
                )}

                {/* Smart suggestions */}
                {suggestions.length > 0 && (
                  <div className="bg-purple-500/10 rounded-xl p-5 border border-purple-500/20 space-y-3">
                    <div className="flex items-center gap-2">
                      <Lightbulb className="w-4 h-4 text-purple-400" />
                      <span className="text-xs text-purple-300 font-bold uppercase tracking-wider">Smart Recommendations</span>
                    </div>
                    {suggestions.map((s, i) => (
                      <div key={i} className="flex items-start gap-2.5 text-sm text-purple-200/80">
                        <div className="w-1.5 h-1.5 rounded-full bg-purple-400 flex-shrink-0 mt-2" />
                        {s}
                      </div>
                    ))}
                  </div>
                )}

                {/* Marginal rate bar on summary */}
                {calc.breakdown.taxableIncome > 0 && (
                  <div className="bg-[#1A1A1A] rounded-xl p-5 border border-white/10">
                    <BracketBar
                      taxableIncome={calc.breakdown.taxableIncome}
                      filingStatus={taxProfile.filingStatus}
                    />
                  </div>
                )}
              </div>
            )}
          </div>

          {/* RIGHT: Live Numbers Panel */}
          <div className="w-[300px] flex-shrink-0 border-l border-white/10 bg-[#0A0A0A] p-6 overflow-y-auto space-y-4 custom-scrollbar hidden lg:flex flex-col">
            <div className="text-xs text-gray-500 uppercase tracking-widest font-bold flex items-center gap-2">
              <Zap className="w-3.5 h-3.5 text-yellow-400" /> Live Calculator
            </div>

            {!calc || calc.breakdown.grossIncome === 0 ? (
              <div className="flex-1 flex flex-col items-center justify-center text-center py-12">
                <div className="p-4 bg-white/5 rounded-2xl mb-4">
                  <Calculator className="w-8 h-8 text-gray-600" />
                </div>
                <p className="text-gray-600 text-sm">Enter income to see<br />live tax calculations</p>
              </div>
            ) : (
              <>
                {/* Big metric */}
                <div className="bg-gradient-to-br from-red-500/15 to-orange-500/10 border border-red-500/20 rounded-2xl p-5 text-center">
                  <div className="text-[11px] text-gray-500 uppercase tracking-widest mb-1">You Owe</div>
                  <div className="text-3xl font-black font-mono text-white">
                    {formatDollarFull(calc.totalTaxLiability)}
                  </div>
                  <div className="text-sm text-gray-400 mt-1">
                    {calc.totalEffectiveRate.toFixed(2)}% effective rate
                  </div>
                </div>

                <MetricCard
                  label="Net Income"
                  value={formatDollarFull(calc.netIncome)}
                  sub={`${(100 - calc.totalEffectiveRate).toFixed(1)}% of gross`}
                  color="green"
                />

                <div className="space-y-2">
                  <div className="text-[10px] text-gray-600 uppercase tracking-widest font-bold">Breakdown</div>
                  {[
                    { label: "Federal", value: calc.federalIncomeTax, rate: calc.federalEffectiveRate, color: "bg-red-500" },
                    { label: `${taxProfile.state} State`, value: calc.stateIncomeTax, rate: calc.stateEffectiveRate, color: "bg-orange-500" },
                    ...(calc.selfEmploymentTax > 0 ? [{ label: "SE Tax", value: calc.selfEmploymentTax, rate: (calc.selfEmploymentTax / calc.breakdown.grossIncome) * 100, color: "bg-yellow-500" }] : []),
                  ].map((item, i) => (
                    <div key={i} className="bg-[#111] rounded-xl p-3 border border-white/5">
                      <div className="flex justify-between items-start mb-2">
                        <span className="text-xs text-gray-400 font-medium">{item.label}</span>
                        <span className="text-xs font-mono font-bold text-white">
                          {formatDollarFull(item.value)}
                        </span>
                      </div>
                      <div className="h-1.5 bg-white/5 rounded-full overflow-hidden">
                        <div
                          className={`h-full rounded-full ${item.color} transition-all duration-500`}
                          style={{ width: `${Math.min(item.rate * 2, 100)}%` }}
                        />
                      </div>
                      <div className="text-[10px] text-gray-600 mt-1">{item.rate.toFixed(2)}% effective</div>
                    </div>
                  ))}
                </div>

                {/* Marginal rate indicator */}
                <div className="bg-[#111] rounded-xl p-4 border border-white/5">
                  <div className="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-2">Federal Bracket</div>
                  <BracketBar
                    taxableIncome={calc.breakdown.taxableIncome}
                    filingStatus={taxProfile.filingStatus}
                  />
                </div>

                {/* Monthly view */}
                <div className="bg-[#111] rounded-xl p-4 border border-white/5">
                  <div className="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-3">Monthly Snapshot</div>
                  <div className="grid grid-cols-2 gap-2 text-center">
                    {[
                      { label: "Gross/mo", value: formatDollar(calc.breakdown.grossIncome / 12), color: "text-white" },
                      { label: "Tax/mo", value: formatDollar(calc.totalTaxLiability / 12), color: "text-red-400" },
                      { label: "Net/mo", value: formatDollar(calc.netIncome / 12), color: "text-emerald-400" },
                      { label: "Tax/day", value: formatDollar(calc.totalTaxLiability / 365), color: "text-orange-400" },
                    ].map((item) => (
                      <div key={item.label} className="bg-black/20 rounded-lg p-2">
                        <div className={`text-base font-bold font-mono ${item.color}`}>{item.value}</div>
                        <div className="text-[10px] text-gray-600">{item.label}</div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Top tip */}
                {suggestions.length > 0 && (
                  <div className="bg-purple-500/10 rounded-xl p-4 border border-purple-500/20">
                    <div className="text-[10px] text-purple-400 uppercase tracking-widest font-bold mb-2">Top Tip</div>
                    <p className="text-xs text-purple-200/80">{suggestions[0]}</p>
                  </div>
                )}
              </>
            )}
          </div>
        </div>

        {/* Footer */}
        <div className="flex items-center justify-between px-8 py-5 border-t border-white/10 flex-shrink-0">
          <div className="flex gap-3">
            <button
              onClick={onClose}
              className="px-5 py-2.5 rounded-xl border border-white/10 text-gray-400 hover:text-white hover:bg-white/5 text-sm font-medium transition-colors"
            >
              Cancel
            </button>
            {currentIndex > 0 && (
              <button
                onClick={() => setStep(steps[currentIndex - 1])}
                className="px-5 py-2.5 rounded-xl border border-blue-500/30 text-blue-400 hover:bg-blue-500/10 text-sm font-medium transition-colors flex items-center gap-2"
              >
                <ChevronLeft className="w-4 h-4" /> Back
              </button>
            )}
          </div>

          {step !== "summary" ? (
            <button
              onClick={() => setStep(steps[currentIndex + 1])}
              disabled={!canNext}
              className="px-8 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold transition-all disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 shadow-lg shadow-blue-500/20"
            >
              Continue <ChevronRight className="w-4 h-4" />
            </button>
          ) : (
            <button
              onClick={handleSave}
              className="px-8 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold transition-all flex items-center gap-2 shadow-lg shadow-emerald-500/20"
            >
              <CheckCircle2 className="w-4 h-4" />
              {profile ? "Update Profile" : "Save Profile"}
            </button>
          )}
        </div>
      </div>

      <style jsx>{`
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }
      `}</style>
    </div>
  );
}
